<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>WebAR GPS Tracker</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        body { margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; background: #000; font-family: sans-serif; }
        
        #camera-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: #111;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #555;
        }
        video { width: 100%; height: 100%; object-fit: cover; display: none; }
        video.active { display: block; }
        #map { flex: 1; width: 100%; }

        /* AR OVERLAY */
        #ar-overlay {
            position: absolute;
            top: 40%; 
            left: 50%;
            transform: translate(-50%, -50%);
            display: none; 
            pointer-events: none;
            text-align: center;
        }
        
        .ar-bubble {
            background: rgba(40, 167, 69, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 18px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            border: 2px solid white;
            white-space: nowrap;
        }
        
        .ar-dist { font-size: 12px; margin-top: 5px; text-shadow: 0 1px 2px black; color: #eee;}

        /* UI CONTROLS */
        #controls {
            position: absolute; bottom: 20px; left: 20px;
            z-index: 1000; display: flex; flex-direction: column; gap: 10px; align-items: flex-start;
        }
        #data-display {
            background: rgba(0, 0, 0, 0.7); padding: 8px 15px; border-radius: 15px;
            margin-bottom: 5px; color: white; display: flex; flex-direction: column; min-width: 140px;
        }
        .data-row { display: flex; justify-content: space-between; align-items: center; font-size: 14px; margin-bottom: 4px; }
        .data-val { font-weight: bold; font-family: monospace; font-size: 16px; }

        .pill-btn {
            background-color: #444; color: white; border: none; padding: 12px 20px;
            border-radius: 50px; font-size: 14px; font-weight: bold; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); text-align: center; width: 160px; 
            transition: background-color 0.2s;
        }
        .pill-btn.active { background-color: #28a745; }
        
        #btn-reset {
            background: #d9534f; color: white; border: none; border-radius: 4px;
            padding: 4px 8px; font-size: 11px; cursor: pointer; margin-top: 5px; align-self: flex-end;
        }

        /* Compass Warning */
        #compass-status {
            position: absolute; top: 10px; right: 10px; 
            background: rgba(255, 0, 0, 0.6); color: white; padding: 5px;
            font-size: 10px; border-radius: 4px; display: none; z-index: 1000;
        }
    </style>
</head>
<body>

    <div id="compass-status">Compass Off</div>

    <div id="camera-container">
        <span id="camera-placeholder">Camera Paused</span>
        <video id="video-feed" autoplay playsinline muted></video>
        
        <div id="ar-overlay">
            <div id="ar-text" class="ar-bubble">Target</div>
            <div id="ar-dist" class="ar-dist">0 ft away</div>
        </div>
    </div>

    <div id="map"></div>

    <div id="controls">
        <div id="data-display">
            <div class="data-row"><span>Dist:</span><span id="dist-val" class="data-val">0.0 ft</span></div>
            <div class="data-row"><span>Elev:</span><span id="elev-val" class="data-val">-- ft</span></div>
            <button id="btn-reset">RESET TRIP</button>
        </div>

        <button id="btn-compass" class="pill-btn">Enable Compass</button>
        <button id="btn-cam" class="pill-btn">Camera Off</button>
        <button id="btn-path" class="pill-btn">GPS Path Off</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/idb-keyval@6.2.1/dist/index.js"></script>

    <script type="module">
        import { get, set, del } from 'https://unpkg.com/idb-keyval@6.2.1/dist/index.js';

        // --- 1. CONFIGURATION ---
        
        // A. The AR Target (The one the camera looks for)
        const AR_TARGET = { 
            lat: 33.976903,   // <--- CHANGE THIS
            lng: 118.401848, // <--- CHANGE THIS
            name: "Target House"
        };

        // --- STATE ---
        let latestFix = null;       
        let deviceHeading = 0; 
        let isCameraOn = false;
        let isPathOn = false;
        let currentStream = null;
        let fullPathData = [];
        let totalDistanceFeet = 0;
        let lastLoggedFix = null;

        // --- DOM ---
        const arOverlay = document.getElementById('ar-overlay');
        const arText = document.getElementById('ar-text');
        const arDist = document.getElementById('ar-dist');
        const btnCompass = document.getElementById('btn-compass');
        const btnCam = document.getElementById('btn-cam');
        const btnPath = document.getElementById('btn-path');
        const btnReset = document.getElementById('btn-reset');
        const videoElement = document.getElementById('video-feed');
        const camPlaceholder = document.getElementById('camera-placeholder');
        const distVal = document.getElementById('dist-val');
        const elevVal = document.getElementById('elev-val');

        // --- MAP SETUP ---
        const map = L.map('map').setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(map);
        const userMarker = L.marker([0, 0]).addTo(map);
        const pathLine = L.polyline([], {color: 'red'}).addTo(map);
        
        
        // --- SECTION 1.5: MAP MARKERS ---

        // 1. Automatically add a pin for the AR Target
        L.marker([AR_TARGET.lat, AR_TARGET.lng])
            .addTo(map)
            .bindPopup(`<b>${AR_TARGET.name}</b><br>(AR Target)`);

        // 2. Add your other Hardcoded POIs here
        L.marker([33.976715, -118.401812]) // <--- Example Park
            .addTo(map)
            .bindPopup("<b>Corinna's House</b><br>Good Neighbor.");

        // Add more markers below if you want!
        // L.marker([lat, lng]).addTo(map).bindPopup("Name");


        // --- 2. COMPASS LOGIC ---
        btnCompass.addEventListener('click', () => {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            window.addEventListener('deviceorientation', handleOrientation);
                            btnCompass.style.display = 'none';
                        } else { alert("Permission denied"); }
                    })
                    .catch(console.error);
            } else {
                window.addEventListener('deviceorientation', handleOrientation);
                btnCompass.style.display = 'none';
            }
        });

        function handleOrientation(event) {
            let heading = event.webkitCompassHeading || Math.abs(event.alpha - 360);
            deviceHeading = heading;
            updateAR(); 
        }

        // --- 3. AR MATH ---
        function updateAR() {
            if (!latestFix || !isCameraOn) return;

            const userLoc = L.latLng(latestFix.lat, latestFix.lng);
            const poiLoc = L.latLng(AR_TARGET.lat, AR_TARGET.lng);
            const distMeters = userLoc.distanceTo(poiLoc);
            const distFeet = distMeters * 3.28084;

            const y = Math.sin(poiLoc.lng * Math.PI/180 - userLoc.lng * Math.PI/180) * Math.cos(poiLoc.lat * Math.PI/180);
            const x = Math.cos(userLoc.lat * Math.PI/180) * Math.sin(poiLoc.lat * Math.PI/180) -
                    Math.sin(userLoc.lat * Math.PI/180) * Math.cos(poiLoc.lat * Math.PI/180) * Math.cos(poiLoc.lng * Math.PI/180 - userLoc.lng * Math.PI/180);
            let bearing = Math.atan2(y, x) * 180 / Math.PI;
            bearing = (bearing + 360) % 360; 

            let diff = bearing - deviceHeading;
            while (diff < -180) diff += 360;
            while (diff > 180) diff -= 360;

            if (distFeet < 300 && Math.abs(diff) < 35) {
                arOverlay.style.display = 'block';
                arText.innerText = AR_TARGET.name;
                arDist.innerText = distFeet.toFixed(0) + " ft";
                const screenPercent = 50 + (diff * 1.5); 
                arOverlay.style.left = screenPercent + "%";
            } else {
                arOverlay.style.display = 'none';
            }
        }

        // --- STANDARD APP LOGIC ---
        btnCam.addEventListener('click', async () => {
            if (!isCameraOn) {
                try {
                    currentStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                    videoElement.srcObject = currentStream;
                    videoElement.classList.add('active');
                    camPlaceholder.style.display = 'none';
                    isCameraOn = true;
                    btnCam.textContent = "Camera On";
                    btnCam.classList.add('active');
                } catch (err) { alert("Camera failed."); }
            } else {
                if (currentStream) currentStream.getTracks().forEach(t => t.stop());
                videoElement.srcObject = null;
                videoElement.classList.remove('active');
                camPlaceholder.style.display = 'block';
                isCameraOn = false;
                btnCam.textContent = "Camera Off";
                btnCam.classList.remove('active');
                arOverlay.style.display = 'none'; 
            }
        });

        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(
                (pos) => {
                    latestFix = { lat: pos.coords.latitude, lng: pos.coords.longitude, alt: pos.coords.altitude || 0, acc: pos.coords.accuracy };
                    userMarker.setLatLng([latestFix.lat, latestFix.lng]);
                    const altFeet = (latestFix.alt * 3.28084).toFixed(0);
                    elevVal.innerText = `${altFeet} ft`;
                    updateAR(); 
                },
                (err) => console.log(err),
                { enableHighAccuracy: true, maximumAge: 0 }
            );
        }

        btnPath.addEventListener('click', () => {
            isPathOn = !isPathOn;
            if (isPathOn) {
                btnPath.textContent = "Recording...";
                btnPath.classList.add('active');
                if (!lastLoggedFix && latestFix) lastLoggedFix = latestFix;
            } else {
                btnPath.textContent = "GPS Path Off";
                btnPath.classList.remove('active');
            }
        });

        btnReset.addEventListener('click', async () => {
            if(!confirm("Reset?")) return;
            fullPathData = []; totalDistanceFeet = 0; pathLine.setLatLngs([]); 
            distVal.innerText = "0.0 ft"; lastLoggedFix = null;
            await del('my-hike-data');
        });

        setInterval(async () => {
            if (latestFix && isPathOn) {
                if (lastLoggedFix) {
                    const from = L.latLng(lastLoggedFix.lat, lastLoggedFix.lng);
                    const to = L.latLng(latestFix.lat, latestFix.lng);
                    const distFeet = from.distanceTo(to) * 3.28084;
                    if (distFeet > 3) {
                        totalDistanceFeet += distFeet;
                        distVal.innerText = `${totalDistanceFeet.toFixed(1)} ft`;
                    }
                }
                fullPathData.push([latestFix.lat, latestFix.lng, latestFix.alt, Date.now()]);
                await set('my-hike-data', fullPathData);
                pathLine.setLatLngs(fullPathData.map(p => [p[0], p[1]]));
                lastLoggedFix = latestFix;
            }
        }, 5000);

    </script>
</body>
</html>
