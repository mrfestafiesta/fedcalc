<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>2025 Federal & State Tax Planner</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 24px; background: #0b0c10; color: #e9eef3; }
    .card { background: #11151a; border: 1px solid #222a33; border-radius: 16px; padding: 20px; max-width: 1120px; margin: 0 auto; }
    h1 { margin: 0 0 14px; font-size: 1.45rem; }
    label { display: block; margin: 10px 0 6px; font-weight: 600; }
    input, select { padding: 10px 12px; border-radius: 10px; border: 1px solid #2a3340; background: #0f1318; color: #e9eef3; }
    input[readonly]{ background:#0c1015; color:#bcd0e0; }
    input { width: 100%; box-sizing: border-box; }
    select { width: 100%; }

    .row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 14px; }
    .row4 { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 14px; }
    .row3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 14px; }
    .row5 { display:grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr; gap: 14px; }

    .labelHeader { font-weight:700; font-size:1.5rem; line-height:1.2; margin:64px 0 12px; text-align:left; }
    .sectionBox { background:#0d1116; border:1px solid #223044; border-radius:12px; padding:14px; }
    .muted { color: #a3b1c2; font-size: 0.92rem; }
    .small { font-size: .9rem; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Step 1 — Filing Status</h1>
    <p class="muted small">Choose the tax filing status that you plan on filing with for the 2025 tax year. Don't worry—you can always change it later without having to redo your inputs.</p>

    <div class="sectionBox">
      <div class="row">
        <div>
          <label for="status">Filing status</label>
          <select id="status">
            <option value="single">Single</option>
            <option value="mfj">Married Filing Jointly</option>
            <option value="hoh">Head of Household</option>
            <option value="mfs">Married Filing Separately</option>
          </select>
        </div>
        <div>
          <label for="state">State of Residence</label>
          <select id="state">
            <option value="" selected disabled>Select</option>
            <option value="CA">CA</option>
            <option value="WA">WA</option>
            <option value="NV">NV</option>
          </select>
        </div>
      </div>
    </div>

    <div class="labelHeader">Step 5 — Deduction Inputs (Below-The-Line)</div>
    <div class="sectionBox">
      <div class="row4">
        <div>
          <label for="qbi">QBI Deduction</label>
          <input id="qbi" type="text" readonly value="$0.00" />
        </div>
        <div>
          <label for="stdDeduction">Standard Deduction</label>
          <input id="stdDeduction" type="text" readonly value="$0.00" />
        </div>
        <div>
          <label for="stdDeductionState">Standard Deduction (State)</label>
          <input id="stdDeductionState" type="text" readonly value="$0.00" />
        </div>
      </div>
  </div>

  <!-- State Tax Calculation -->
  <div class="labelHeader">State Income Tax</div>
  <div class="sectionBox">
    <div class="row3">
      <div>
        <label for="stateTaxableBase">State Taxable Income</label>
        <input id="stateTaxableBase" type="text" value="$0.00" />
        <p class="muted small">Enter the income amount your state taxes (e.g., AGI minus state adjustments and the state standard deduction).</p>
      </div>
      <div>
        <label for="stateTaxOwed">State Income Tax Owed</label>
        <input id="stateTaxOwed" type="text" readonly value="$0.00" />
      </div>
    </div>
  </div>
  </div>

  <script>
    let STATE_TAX_TABLES = {};
    let stateTablesLoaded = false;

    function loadStateTables() {
      if (stateTablesLoaded) return Promise.resolve(STATE_TAX_TABLES);
      return fetch('state-tax-tables-2025.json')
        .then(r => r.json())
        .then(data => {
          STATE_TAX_TABLES = data || {};
          stateTablesLoaded = true;
          return STATE_TAX_TABLES;
        })
        .catch(() => {
          STATE_TAX_TABLES = {};
          stateTablesLoaded = true;
          return STATE_TAX_TABLES;
        });
    }

    function setMoneyInput(id, value) {
      const el = document.getElementById(id);
      if (el) el.value = '$' + (Number(value)||0).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
    }
    function parseMoney(s){
      if (s == null) return 0;
      const cleaned = String(s).replace(/[^0-9.-]/g,'');
      const n = parseFloat(cleaned);
      return isNaN(n) ? 0 : n;
    }
    function computeTaxByBracket(taxable, brackets){
      let remaining = Math.max(0, Number(taxable)||0);
      let prior = 0;
      let total = 0;
      for (const b of (brackets||[])){
        const capRaw = (b && b.upTo);
        const cap = (capRaw === 'Infinity' || capRaw === Infinity) ? Infinity : Number(capRaw)||0;
        const limit = isFinite(cap) ? cap : prior + remaining; // for Infinity, consume all remaining
        const slice = Math.max(0, Math.min(remaining, limit - prior));
        total += slice * (Number(b.rate)||0);
        remaining -= slice;
        prior = isFinite(cap) ? cap : prior + slice;
        if (remaining <= 0) break;
      }
      return total;
    }
    function computeStateTax(stateCfg, status, taxable){
      if (!stateCfg) return 0;
      const br = (stateCfg.brackets && stateCfg.brackets[status]) || [];
      if (!br.length) return 0;
      return computeTaxByBracket(taxable, br);
    }

    function render(){
      const status = document.getElementById('status')?.value || 'single';
      const stateSel = (document.getElementById('state')?.value || '').trim();

      // 1) State standard deduction box
      let stdState = 0;
      if (stateSel && stateTablesLoaded && STATE_TAX_TABLES[stateSel]) {
        const stateCfg = STATE_TAX_TABLES[stateSel];
        const stdMap = (stateCfg && stateCfg.standardDeduction) || {};
        stdState = Number(stdMap[status]) || 0;
      }
      setMoneyInput('stdDeductionState', stdState);

      // 2) State tax owed (user-controlled taxable base)
      const taxableBase = parseMoney(document.getElementById('stateTaxableBase')?.value || 0);
      let stateTax = 0;
      if (stateSel && stateTablesLoaded && STATE_TAX_TABLES[stateSel]) {
        stateTax = computeStateTax(STATE_TAX_TABLES[stateSel], status, Math.max(0, taxableBase));
      }
      setMoneyInput('stateTaxOwed', stateTax);
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadStateTables().then(() => {
        render();
        const statusEl = document.getElementById('status');
        const stateEl = document.getElementById('state');
        if (statusEl) statusEl.addEventListener('change', render);
        if (stateEl) stateEl.addEventListener('change', render);

        const taxBaseEl = document.getElementById('stateTaxableBase');
        if (taxBaseEl){
          taxBaseEl.addEventListener('focus', () => {
            taxBaseEl.value = String(parseMoney(taxBaseEl.value) || '');
          });
          taxBaseEl.addEventListener('blur', () => {
            taxBaseEl.value = '$' + (Number(parseMoney(taxBaseEl.value))||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});
            render();
          });
          taxBaseEl.addEventListener('input', () => { render(); });
        }
      });
    });
  </script>
</body>
</html>
