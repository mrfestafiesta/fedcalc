<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>3D GPS Tracker + POIs</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        body { margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; background: #000; font-family: sans-serif; }
        
        /* CAMERA & MAP */
        #camera-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: #111;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #555;
        }
        video { width: 100%; height: 100%; object-fit: cover; display: none; }
        video.active { display: block; }
        #map { flex: 1; width: 100%; }

        /* UI OVERLAYS */
        #status {
            position: absolute; top: 10px; left: 10px;
            background: rgba(0, 0, 0, 0.6); color: white;
            padding: 4px 8px; border-radius: 4px; font-size: 12px;
            z-index: 1000; pointer-events: none; white-space: pre-line;
        }

        #controls {
            position: absolute; bottom: 20px; left: 20px;
            z-index: 1000; display: flex; flex-direction: column; gap: 10px; align-items: flex-start;
        }

        #data-display {
            background: rgba(0, 0, 0, 0.7); padding: 8px 15px; border-radius: 15px;
            margin-bottom: 5px; color: white; display: flex; flex-direction: column; min-width: 140px;
        }
        .data-row { display: flex; justify-content: space-between; align-items: center; font-size: 14px; margin-bottom: 4px; }
        .data-val { font-weight: bold; font-family: monospace; font-size: 16px; }

        /* BUTTONS */
        .pill-btn {
            background-color: #444; color: white; border: none; padding: 12px 20px;
            border-radius: 50px; font-size: 14px; font-weight: bold; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); text-align: center; width: 160px; 
            transition: background-color 0.2s;
        }
        .pill-btn.active { background-color: #28a745; }
        
        #btn-reset {
            background: #d9534f; color: white; border: none; border-radius: 4px;
            padding: 4px 8px; font-size: 11px; cursor: pointer; margin-top: 5px; align-self: flex-end;
        }

        /* CHART MODAL */
        #chart-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 2000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        #chart-container { width: 90%; height: 50%; background: white; border-radius: 8px; padding: 10px; }
        #close-chart {
            margin-top: 20px; padding: 10px 30px; background: white; border: none;
            font-weight: bold; border-radius: 50px; cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="status">Initializing System...</div>

    <div id="camera-container">
        <span id="camera-placeholder">Camera Paused</span>
        <video id="video-feed" autoplay playsinline muted></video>
    </div>

    <div id="map"></div>

    <div id="controls">
        <div id="data-display">
            <div class="data-row"><span>Dist:</span><span id="dist-val" class="data-val">0.0 ft</span></div>
            <div class="data-row"><span>Elev:</span><span id="elev-val" class="data-val">-- ft</span></div>
            <button id="btn-reset">RESET TRIP</button>
        </div>

        <button id="btn-graph" class="pill-btn">Show Elevation</button>
        <button id="btn-cam" class="pill-btn">Camera Off</button>
        <button id="btn-path" class="pill-btn">GPS Path Off</button>
    </div>

    <div id="chart-modal">
        <div id="chart-container"><canvas id="elevationChart"></canvas></div>
        <button id="close-chart">Close Graph</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script type="module">
        import { get, set, del } from 'https://unpkg.com/idb-keyval@6.2.1/dist/index.js';

        // --- STATE ---
        let latestFix = null;       
        let lastLoggedFix = null;   
        let fullPathData = []; 
        let totalDistanceFeet = 0;
        let isCameraOn = false;
        let isPathOn = false;
        let currentStream = null;
        let myChart = null;

        // --- DOM ---
        const statusDiv = document.getElementById('status');
        const distVal = document.getElementById('dist-val');
        const elevVal = document.getElementById('elev-val');
        const videoElement = document.getElementById('video-feed');
        const camPlaceholder = document.getElementById('camera-placeholder');
        const btnCam = document.getElementById('btn-cam');
        const btnPath = document.getElementById('btn-path');
        const btnReset = document.getElementById('btn-reset');
        
        const btnGraph = document.getElementById('btn-graph');
        const chartModal = document.getElementById('chart-modal');
        const btnCloseChart = document.getElementById('close-chart');

        // --- SECTION 1: MAP INITIALIZATION ---
        const map = L.map('map').setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(map);
        
        const userMarker = L.marker([0, 0]).addTo(map);
        const pathLine = L.polyline([], {color: 'red'}).addTo(map);
        const dotLayer = L.layerGroup().addTo(map);

        // --- SECTION 1.5: HARDCODED POINTS OF INTEREST (POIs) ---
        // EDIT HERE: Add your own markers!
        
        // Example 1: A House (Los Angeles)
        L.marker([33.977455, -118.402039]) // <--- REPLACE THESE NUMBERS
            .addTo(map)
            .bindPopup("<b>Roger's House</b><br>This is the starting point.");

        // Example 2: A Park
        L.marker([33.977850, -118.402509]) // <--- REPLACE THESE NUMBERS
            .addTo(map)
            .bindPopup("<b>Lot 87</b><br>Good spot for lunch.");


        // --- SECTION 2: LOAD DATA ---
        async function loadSavedTrip() {
            try {
                const savedPath = await get('my-hike-data');
                if (savedPath && savedPath.length > 0) {
                    fullPathData = savedPath;
                    const latLngs = fullPathData.map(p => [p[0], p[1]]);
                    pathLine.setLatLngs(latLngs);
                    latLngs.forEach(pt => L.circleMarker(pt, {radius: 4, color: 'orange', fillColor: '#f03', fillOpacity: 0.8}).addTo(dotLayer));

                    let restoredDist = 0;
                    for(let i=1; i<latLngs.length; i++) {
                        restoredDist += map.distance(latLngs[i-1], latLngs[i]);
                    }
                    totalDistanceFeet = restoredDist * 3.28084;
                    distVal.innerText = `${totalDistanceFeet.toFixed(1)} ft`;
                    
                    const lastPoint = fullPathData[fullPathData.length - 1];
                    lastLoggedFix = { lat: lastPoint[0], lng: lastPoint[1] };
                    map.setView([lastPoint[0], lastPoint[1]], 16);
                }
            } catch (err) { console.error(err); }
        }
        loadSavedTrip();

        // --- SECTION 3: CHART LOGIC ---
        function showChart() {
            if (fullPathData.length < 2) {
                alert("Not enough data to graph yet. Walk a bit!");
                return;
            }
            const labels = [];
            const dataPoints = [];
            let accumDist = 0;
            
            for (let i = 0; i < fullPathData.length; i++) {
                const point = fullPathData[i];
                const altFeet = point[2] * 3.28084;
                if (i > 0) {
                    const prev = fullPathData[i-1];
                    const distMeters = map.distance([prev[0], prev[1]], [point[0], point[1]]);
                    accumDist += (distMeters * 3.28084);
                }
                labels.push(accumDist.toFixed(0));
                dataPoints.push(altFeet);
            }

            const ctx = document.getElementById('elevationChart').getContext('2d');
            if (myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Elevation (ft)',
                        data: dataPoints,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: 'Distance (ft)' } },
                        y: { title: { display: true, text: 'Altitude (ft)' } }
                    }
                }
            });
            chartModal.style.display = 'flex';
        }

        btnGraph.addEventListener('click', showChart);
        btnCloseChart.addEventListener('click', () => { chartModal.style.display = 'none'; });

        // --- SECTION 4: CAMERA ---
        btnCam.addEventListener('click', async () => {
            if (!isCameraOn) {
                try {
                    currentStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                    videoElement.srcObject = currentStream;
                    videoElement.classList.add('active');
                    camPlaceholder.style.display = 'none';
                    isCameraOn = true;
                    btnCam.textContent = "Camera On";
                    btnCam.classList.add('active');
                } catch (err) { alert("Camera failed."); }
            } else {
                if (currentStream) currentStream.getTracks().forEach(t => t.stop());
                videoElement.srcObject = null;
                videoElement.classList.remove('active');
                camPlaceholder.style.display = 'block';
                isCameraOn = false;
                btnCam.textContent = "Camera Off";
                btnCam.classList.remove('active');
            }
        });

        // --- SECTION 5: GPS ---
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(
                (pos) => {
                    latestFix = { 
                        lat: pos.coords.latitude, 
                        lng: pos.coords.longitude, 
                        alt: pos.coords.altitude || 0, 
                        acc: pos.coords.accuracy 
                    };
                    userMarker.setLatLng([latestFix.lat, latestFix.lng]);
                    
                    // Note: We commented out map.setView() so the map doesn't 
                    // snap back to you while you are trying to look at the house marker!
                    // map.setView([latestFix.lat, latestFix.lng]); 
                    
                    const altFeet = (latestFix.alt * 3.28084).toFixed(0);
                    statusDiv.innerText = `GPS Active\nAcc: ${latestFix.acc.toFixed(0)}m`;
                    elevVal.innerText = `${altFeet} ft`;
                },
                (err) => statusDiv.innerText = "Waiting for GPS...",
                { enableHighAccuracy: true, maximumAge: 0 }
            );
        }

        // --- SECTION 6: RECORDING ---
        btnPath.addEventListener('click', () => {
            isPathOn = !isPathOn;
            if (isPathOn) {
                btnPath.textContent = "Recording...";
                btnPath.classList.add('active');
                if (!lastLoggedFix && latestFix) lastLoggedFix = latestFix;
            } else {
                btnPath.textContent = "GPS Path Off";
                btnPath.classList.remove('active');
            }
        });

        // --- SECTION 7: RESET ---
        btnReset.addEventListener('click', async () => {
            if(!confirm("Delete all saved path data?")) return;
            fullPathData = [];
            totalDistanceFeet = 0;
            pathLine.setLatLngs([]);
            dotLayer.clearLayers();
            distVal.innerText = "0.0 ft";
            lastLoggedFix = null;
            await del('my-hike-data');
            alert("Trip reset.");
        });

        // --- SECTION 8: TIMER ---
        setInterval(async () => {
            if (latestFix && isPathOn) {
                if (lastLoggedFix) {
                    const from = L.latLng(lastLoggedFix.lat, lastLoggedFix.lng);
                    const to = L.latLng(latestFix.lat, latestFix.lng);
                    const distMeters = from.distanceTo(to);
                    const distFeet = distMeters * 3.28084;

                    if (distFeet > 3) {
                        totalDistanceFeet += distFeet;
                        distVal.innerText = `${totalDistanceFeet.toFixed(1)} ft`;
                    }
                }

                const newPoint = [latestFix.lat, latestFix.lng, latestFix.alt, Date.now()];
                fullPathData.push(newPoint);
                await set('my-hike-data', fullPathData);

                L.circleMarker([latestFix.lat, latestFix.lng], {radius: 4, color: 'orange', fillColor: '#f03', fillOpacity: 0.8}).addTo(dotLayer);
                const simplePath = fullPathData.map(p => [p[0], p[1]]);
                pathLine.setLatLngs(simplePath);
                lastLoggedFix = latestFix;
            }
        }, 5000); 
    </script>
</body>
</html>
